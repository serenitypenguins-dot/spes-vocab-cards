<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vocab Cards</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="container">
    <h1>üìö Vocab Cards</h1>
    <p class="subtitle">Paste your word list, pick a style, and get printable flashcard sheets.</p>

    <!-- ‚îÄ‚îÄ STEP 1: Input ‚îÄ‚îÄ -->
    <div id="step1">
      <div class="step-badge">Step 1 of 4 ‚Äî Enter Words</div>

      <div class="field">
        <label for="words">Word List <span style="font-weight:400;color:#a0aec0">(one per line)</span></label>
        <textarea id="words" placeholder="apple&#10;strike&#10;cycle&#10;bat&#10;..."></textarea>
        <p class="hint">üí° Already know the meaning? Add it: <code>strike (lightning strike)</code></p>
      </div>

      <div class="field">
        <label for="grade">Grade Level</label>
        <select id="grade">
          <option value="k" selected>Kindergarten</option>
          <option value="1">1st Grade</option>
          <option value="2">2nd Grade</option>
          <option value="3">3rd Grade</option>
          <option value="4">4th Grade</option>
          <option value="5">5th Grade</option>
        </select>
      </div>

      <div class="field">
        <label>Art Style</label>
        <div class="radio-group">
          <label class="radio-option">
            <input type="radio" name="style" value="cartoon" checked>
            <div><div class="label">Cartoon Clipart</div><div class="desc">Bright, simple, kid-friendly</div></div>
          </label>
          <label class="radio-option">
            <input type="radio" name="style" value="watercolor">
            <div><div class="label">Watercolor</div><div class="desc">Soft watercolor painting style</div></div>
          </label>
          <label class="radio-option">
            <input type="radio" name="style" value="linedrawing">
            <div><div class="label">Simple Line Drawing</div><div class="desc">Clean black line drawing</div></div>
          </label>
          <label class="radio-option">
            <input type="radio" name="style" value="realistic">
            <div><div class="label">Realistic Photo</div><div class="desc">Realistic photograph style</div></div>
          </label>
        </div>
      </div>

      <div class="field">
        <label for="code">Access Code</label>
        <input type="text" id="code" placeholder="Enter your access code" autocomplete="off">
      </div>

      <button class="primary" id="step1Btn" onclick="fetchMeanings()">Next ‚Üí Choose Meanings</button>
    </div>

    <!-- ‚îÄ‚îÄ STEP 2: Select Meanings ‚îÄ‚îÄ -->
    <div id="step2" style="display:none;">
      <div class="step-badge">Step 2 of 4 ‚Äî Choose Meanings</div>
      <p class="subtitle">Select which meaning to illustrate for each word. Check multiple to get multiple cards.</p>

      <div id="meaningsGrid"></div>

      <div class="step-actions">
        <button class="secondary" onclick="goBack(1)">‚Üê Back</button>
        <button class="primary" onclick="generateImages()">Next ‚Üí Generate Images</button>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Progress ‚îÄ‚îÄ -->
    <div class="progress-area" id="progressArea">
      <div class="progress-bar-track">
        <div class="progress-bar-fill" id="progressFill"></div>
      </div>
      <p class="progress-text" id="progressText">Starting...</p>
    </div>

    <div class="error-msg" id="errorMsg"></div>

    <!-- ‚îÄ‚îÄ STEP 3: Preview Images ‚îÄ‚îÄ -->
    <div id="step3" style="display:none;">
      <div class="step-badge">Step 3 of 4 ‚Äî Review Cards</div>
      <p class="subtitle">Review each card. Uncheck to exclude, or regenerate with a custom prompt.</p>

      <div id="cardGrid"></div>

      <div class="step-actions">
        <button class="secondary" onclick="selectAll(true)">Select All</button>
        <button class="secondary" onclick="selectAll(false)">Deselect All</button>
        <button class="primary" onclick="finalize()">üìÑ Generate PDF</button>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ STEP 4: Download ‚îÄ‚îÄ -->
    <div id="step4" style="display:none;">
      <div class="step-badge">Step 4 of 4 ‚Äî Download</div>
      <p class="subtitle">Your vocabulary cards are ready!</p>
      <button class="download" id="downloadBtn">‚¨á Download PDF</button>
      <button class="secondary" onclick="startOver()" style="margin-top:12px;width:100%;">Start Over</button>
    </div>
  </div>

  <script>
    let currentJobId = null;
    let currentCards = [];
    let wordMeanings = []; // from step 2

    function showStep(n) {
      [1,2,3,4].forEach(i => {
        document.getElementById('step' + i).style.display = i === n ? 'block' : 'none';
      });
      document.getElementById('progressArea').style.display = 'none';
      document.getElementById('errorMsg').style.display = 'none';
    }

    function goBack(step) { showStep(step); }
    function startOver() { showStep(1); }

    function showError(msg) {
      const el = document.getElementById('errorMsg');
      el.textContent = msg;
      el.style.display = 'block';
    }

    // ‚îÄ‚îÄ Step 1 ‚Üí Step 2: Fetch meanings ‚îÄ‚îÄ
    async function fetchMeanings() {
      const text = document.getElementById('words').value.trim();
      if (!text) return alert('Please enter some words.');
      const words = text.split('\n').map(w => w.trim()).filter(Boolean);
      if (!words.length) return alert('Please enter some words.');

      const code = document.getElementById('code').value.trim();
      if (!code) return alert('Please enter an access code.');
      const grade = document.getElementById('grade').value;

      const btn = document.getElementById('step1Btn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Looking up meanings...';

      try {
        const res = await fetch('/meanings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ words, grade, code }),
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        wordMeanings = data.words;
        renderMeanings();
        showStep(2);
      } catch (err) {
        showError(err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Next ‚Üí Choose Meanings';
      }
    }

    function renderMeanings() {
      const grid = document.getElementById('meaningsGrid');
      grid.innerHTML = '';

      wordMeanings.forEach((item, wi) => {
        const div = document.createElement('div');
        div.className = 'meaning-card';

        let meaningsHtml = '';
        item.meanings.forEach((m, mi) => {
          const checked = item.has_context || mi === 0 ? 'checked' : '';
          meaningsHtml += `
            <label class="meaning-option">
              <input type="checkbox" ${checked} data-word-index="${wi}" data-meaning-index="${mi}" value="${m.replace(/"/g, '&quot;')}">
              <span>${m}</span>
            </label>
          `;
        });

        div.innerHTML = `
          <div class="meaning-word">${item.word}</div>
          ${item.has_context ? '<div class="meaning-note">‚úÖ You specified this meaning</div>' : ''}
          <div class="meaning-options">${meaningsHtml}</div>
        `;
        grid.appendChild(div);
      });
    }

    // ‚îÄ‚îÄ Step 2 ‚Üí Step 3: Generate images ‚îÄ‚îÄ
    async function generateImages() {
      const code = document.getElementById('code').value.trim();
      const grade = document.getElementById('grade').value;
      const style = document.querySelector('input[name="style"]:checked').value;

      // Collect selected meanings
      const selections = [];
      document.querySelectorAll('#meaningsGrid input[type="checkbox"]:checked').forEach(cb => {
        const wi = parseInt(cb.dataset.wordIndex);
        selections.push({
          word: wordMeanings[wi].word,
          meaning: cb.value,
        });
      });

      if (!selections.length) return alert('Please select at least one meaning.');

      document.getElementById('step2').style.display = 'none';
      const progressArea = document.getElementById('progressArea');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      progressArea.style.display = 'block';
      progressFill.style.width = '0%';
      progressText.textContent = 'Starting image generation...';

      try {
        const res = await fetch('/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ selections, grade, style, code }),
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        currentJobId = data.job_id;
        const evtSource = new EventSource(`/status/${currentJobId}`);

        evtSource.onmessage = (e) => {
          const info = JSON.parse(e.data);
          if (info.status === 'error') {
            evtSource.close();
            showError(info.error || 'Something went wrong.');
            return;
          }
          const pct = info.total > 0 ? Math.round((info.progress / info.total) * 100) : 0;
          progressFill.style.width = pct + '%';

          if (info.status === 'preview') {
            evtSource.close();
            currentCards = info.cards;
            showPreview();
          } else {
            progressText.textContent = `üé® ${info.progress}/${info.total} ‚Äî generating "${info.current_word}"...`;
          }
        };

        evtSource.onerror = () => {
          evtSource.close();
          showError('Lost connection. Please try again.');
        };
      } catch (err) {
        showError(err.message);
      }
    }

    // ‚îÄ‚îÄ Step 3: Preview ‚îÄ‚îÄ
    function showPreview() {
      const grid = document.getElementById('cardGrid');
      grid.innerHTML = '';

      currentCards.forEach((card, i) => {
        const div = document.createElement('div');
        div.className = 'preview-card';
        div.id = `card-${i}`;
        div.innerHTML = `
          <div class="card-top">
            <label class="card-check">
              <input type="checkbox" checked data-index="${i}" onchange="toggleCard(${i}, this.checked)">
            </label>
            <img src="${card.image_filename ? '/image/' + currentJobId + '/' + card.image_filename : ''}"
                 alt="${card.word}" class="card-img" id="card-img-${i}"
                 onerror="this.style.display='none'">
          </div>
          <div class="card-info">
            <div class="card-word">${card.word}</div>
            ${card.meaning ? `<div class="card-meaning">${card.meaning}</div>` : ''}
          </div>
          <div class="card-actions">
            <input type="text" class="regen-input" id="regen-input-${i}"
                   placeholder="Custom prompt (optional)">
            <button class="regen-btn" onclick="regenerate(${i})" id="regen-btn-${i}">üîÑ</button>
          </div>
        `;
        grid.appendChild(div);
      });

      showStep(3);
    }

    function toggleCard(index, checked) {
      document.getElementById(`card-${index}`).classList.toggle('card-excluded', !checked);
    }

    function selectAll(checked) {
      document.querySelectorAll('#cardGrid input[type="checkbox"]').forEach(cb => {
        cb.checked = checked;
        toggleCard(parseInt(cb.dataset.index), checked);
      });
    }

    async function regenerate(index) {
      const btn = document.getElementById(`regen-btn-${index}`);
      const input = document.getElementById(`regen-input-${index}`);
      const img = document.getElementById(`card-img-${index}`);
      const prompt = input.value.trim();

      btn.disabled = true;
      btn.textContent = '‚è≥';

      try {
        const res = await fetch(`/regenerate/${currentJobId}/${index}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt }),
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        img.src = `/image/${currentJobId}/${data.image_filename}`;
        img.style.display = '';
        currentCards[index].image_filename = data.image_filename;
        if (data.meaning) {
          currentCards[index].meaning = data.meaning;
          const el = document.querySelector(`#card-${index} .card-meaning`);
          if (el) el.textContent = data.meaning;
        }
        input.value = '';
      } catch (err) {
        alert('Failed: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîÑ';
      }
    }

    // ‚îÄ‚îÄ Step 3 ‚Üí Step 4: Finalize ‚îÄ‚îÄ
    async function finalize() {
      const accepted = [];
      document.querySelectorAll('#cardGrid input[type="checkbox"]').forEach(cb => {
        if (cb.checked) accepted.push(parseInt(cb.dataset.index));
      });
      if (!accepted.length) return alert('Please select at least one card.');

      try {
        const res = await fetch(`/finalize/${currentJobId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accepted }),
        });
        const data = await res.json();
        if (data.error) throw new Error(data.error);

        document.getElementById('downloadBtn').onclick = () => {
          window.location.href = `/download/${currentJobId}`;
        };
        showStep(4);
      } catch (err) {
        showError(err.message);
      }
    }
  </script>
</body>
</html>
